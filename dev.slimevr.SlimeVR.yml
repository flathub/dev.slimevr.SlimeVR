app-id: dev.slimevr.SlimeVR
runtime: org.gnome.Platform
sdk: org.gnome.Sdk
runtime-version: '48'
separate-locales: false
command: slimevr
finish-args:
  # Network access
  - --share=network
  # Needed for serial communication with trackers
  - --device=all
  # Needed for graphics
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # Needed for audio
  - --socket=pulseaudio
  # Add JRE bin on path
  - --env=PATH=/app/jre/bin:/usr/bin:/app/bin
  #- --env=GDK_BACKEND=wayland,x11
# build dependencies
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
  - org.freedesktop.Sdk.Extension.rust-stable
modules:
  # We need LibUSB for HID4Java
  - shared-modules/libusb/libusb.json
  # We need the JRE for executing the server
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/install.sh
  - name: slimevr-server
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/slimevr
      - install -Dm755 slimevr.jar /app/share/slimevr/slimevr.jar
    sources:
      - type: file
        url: https://github.com/SlimeVR/SlimeVR-Server/releases/download/v0.17.0/slimevr.jar
        sha256: 9f6b186ed490368ae8bcc3db560ab1f267e1c5c0ca4bb7f22a8f946d982d671a
        x-checker-data:
          type: anitya
          project-id: 383505
          url-template: https://github.com/SlimeVR/SlimeVR-Server/releases/download/v$version/slimevr.jar
  - name: slimevr-gui
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/slimevr-gui/cargo
    build-commands:
      - sed -i gui/src-tauri/dev.slimevr.SlimeVR.desktop -e "s|{{exec}}|slimevr|"
        -e "s|{{icon}}|dev.slimevr.SlimeVR|"
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - mkdir -p gui/dist/ && tar -xf slimevr-gui-dist.tar.gz -C gui/dist && ls -l
        gui/dist
      - cargo --offline build --release
      - install -Dm644 gui/src-tauri/icons/icon.svg /app/share/icons/hicolor/scalable/apps/dev.slimevr.SlimeVR.svg
      - install -Dm644 -t /app/share/metainfo dev.slimevr.SlimeVR.metainfo.xml
      - install -Dm644 -t /app/share/applications gui/src-tauri/dev.slimevr.SlimeVR.desktop
      - install -Dm755 target/release/slimevr /app/bin/slimevr-bin
      - install -Dm755 slimevr-wrapper /app/bin/slimevr
    sources:
      - type: git
        url: https://github.com/SlimeVR/SlimeVR-Server.git
        tag: v0.17.0
        commit: b02234f9fc9c1fbaa0d2008d2eb118b3a36b8854
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
          version-scheme: semantic
          is-main-source: true
      # Patch for not checking if git is clean
      - type: patch
        path: clean.diff
      - type: file
        path: dev.slimevr.SlimeVR.metainfo.xml
      - type: file
        url: https://github.com/SlimeVR/SlimeVR-Server/releases/download/v0.17.0/slimevr-gui-dist.tar.gz
        sha256: 30c5074d675bca9247da2d02f52a3e8bafa254e793569e0ed6d84f598ce49417
        x-checker-data:
          type: anitya
          project-id: 383505
          url-template: https://github.com/SlimeVR/SlimeVR-Server/releases/download/v$version/slimevr-gui-dist.tar.gz
      - cargo-sources.json
      - type: script
        dest-filename: slimevr-wrapper
        commands:
          - export TMPDIR="$XDG_RUNTIME_DIR/app/$FLATPAK_ID"
          - exec /app/bin/slimevr-bin "$@"
